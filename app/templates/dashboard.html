{% extends "base.html" %}
{% block title %}Vibe Stats Dashboard | VibeShare{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="flash-message-container" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50">
      {% for category, message in messages %}
        <div class="bg-gradient-to-b from-blue-100 via-blue-200 to-pink-100 text-blue-900 px-6 py-3 rounded-lg shadow-lg font-semibold mb-2 flex items-center space-x-2 animate-fade-in">
          <span>{{ message }}</span>
          <button onclick="this.parentElement.style.display='none'" class="ml-4 text-lg font-bold">&times;</button>
        </div>
      {% endfor %}
    </div>
    <script>
      setTimeout(function() {
        var flash = document.getElementById('flash-message-container');
        if (flash) { flash.style.display = 'none'; }
      }, 3000);
    </script>
    <style>
      @keyframes fade-in {
        from { opacity: 0; transform: translateY(-10px);}
        to { opacity: 1; transform: translateY(0);}
      }
      .animate-fade-in {
        animation: fade-in 0.5s;
      }
    </style>
  {% endif %}
{% endwith %}

<div class="min-h-screen w-full overflow-x-hidden py-8 px-4">
  <div class="max-w-screen-2xl mx-auto space-y-12">
    <!-- Spotify Connect Button -->
    <div class="relative z-50 flex justify-end mb-6">
      {% if session.get('spotify_token') %}
        <span class="text-green-600 font-semibold">Spotify Connected</span>
      {% else %}
        <form action="{{ url_for('auth.login_spotify') }}" method="get">
          <button type="submit"class="bg-gradient-to-r from-indigo-400 to-pink-400 text-white font-semibold px-4 py-2 rounded-full shadow-md hover:opacity-90 transition duration-200">
            Connect Spotify
          </button>
        </form>
      {% endif %}
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div class="bg-white rounded-2xl shadow-lg p-8 transition transform duration-300 hover:scale-105 hover:shadow-2xl">
        <h2 class="text-2xl font-bold text-indigo-700 mb-2">Total Minutes Played by Track</h2>
        <p class="text-sm text-gray-500 mb-6">See which tracks you've dedicated the most listening time to.</p>
        <div class="w-full overflow-x-auto">
          <canvas id="minutesByTrack" class="w-full h-auto max-w-full"></canvas>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-8 transition transform duration-300 hover:scale-105 hover:shadow-2xl">
        <h2 class="text-2xl font-bold text-indigo-700 mb-2">Danceability vs Energy</h2>
        <p class="text-sm text-gray-500 mb-6">Bubble size = minutes played. Shows whether you spend more time on chill tracks or energetic ones. Larger bubbles mean more listening time.</p>
        <div class="w-full overflow-x-auto">
          <canvas id="danceabilityEnergy" class="w-full h-auto max-w-full"></canvas>
        </div>
      </div>
    </div>

    <!-- Grid Section -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">

          <!-- Summary Card -->
    <div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col space-y-6 transition transform duration-300 hover:scale-105 hover:shadow-2xl">
      <h2 class="text-xl font-semibold text-gray-700">Summary Card</h2>
      <p class="text-sm text-gray-400 -mt-1">See your listening habits in a nutshell.</p>

      <!-- Most Played Track -->
      <div class="flex items-center space-x-4">
        <div class="bg-gradient-to-br from-indigo-400 to-pink-400 p-3 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-2v13"/>
            <circle cx="6" cy="18" r="3" fill="currentColor"/>
            <circle cx="18" cy="16" r="3" fill="currentColor"/>
          </svg>
        </div>
        <div>
          <p class="text-xs text-gray-400">Most Played Track</p>
          <p class="text-lg font-bold text-indigo-700">{{ top_tracks.most_played }}</p>
        </div>
      </div>

      <!-- Total Minutes Played -->
      <div class="flex items-center space-x-4">
        <div class="bg-gradient-to-br from-indigo-400 to-pink-400 p-3 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
            <path stroke="currentColor" stroke-width="2" stroke-linecap="round" d="M12 6v6l4 2"/>
          </svg>
        </div>
        <div>
          <p class="text-xs text-gray-400">Total Minutes Played</p>
          <p class="text-lg font-bold text-indigo-700">{{ top_tracks.total_minutes }}</p>
        </div>
      </div>

      <!-- Average Tempo -->
      <div class="flex items-center space-x-4">
        <div class="bg-gradient-to-br from-indigo-400 to-pink-400 p-3 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v18m0 0l-6-6m6 6l6-6"/>
            <circle cx="12" cy="17" r="1.5" fill="currentColor"/>
          </svg>
        </div>
        <div>
          <p class="text-xs text-gray-400">Average Tempo</p>
          <p class="text-lg font-bold text-pink-600">{{ top_tracks.avg_tempo }} BPM</p>
        </div>
      </div>

      <!-- Top Mood -->
      <div class="flex items-center space-x-4">
        <div class="bg-gradient-to-br from-green-400 to-teal-400 p-3 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14h.01M9 10h.01M15 10h.01M9.172 16.172a4 4 0 005.656 0"/>
          </svg>
        </div>
        <div>
          <p class="text-xs text-gray-400">Top Mood</p>
          <p class="text-lg font-bold text-green-600">
            {% if major > minor %}
              Happy
            {% elif major < minor %}
              Emotional
            {% else %}
              Balance
            {% endif %}
          </p>
        </div>
      </div>
    </div>

      <!-- Mood Profile Radar Chart -->
      <div class="bg-white rounded-2xl shadow-lg p-8 transition transform duration-300 hover:scale-105 hover:shadow-2xl">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Mood Profile</h2>
        <p class="text-xs text-gray-400 mb-4">Visualize your music mood distribution.</p>
        <div class="w-full overflow-x-auto">
          <canvas id="moodProfile" class="w-full h-auto max-w-full"></canvas>
        </div>
      </div>

      <!-- Mode Analysis -->
      <div class="bg-white rounded-2xl shadow-lg p-8 transition transform duration-300 hover:scale-105 hover:shadow-2xl">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Listening Time by Mode</h2>
        <p class="text-xs text-gray-400 mb-4">Happy (Major) vs Emotional (Minor) moods.</p>
        <div class="w-full overflow-x-auto">
          <canvas id="modeChart" class="w-full h-auto max-w-full"></canvas>
        </div>
        <div class="text-xs text-gray-500 mt-4">
          <p><span class="font-bold">Major:</span> Happy and uplifting tones.</p>
          <p><span class="font-bold">Minor:</span> Emotional or somber tones.</p>
        </div>
      </div>

      <!-- Top Artists -->
      <div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col w-full h-full">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Top Artists</h2>
        <p class="text-xs text-gray-400 mb-4">Your most listened artists</p>
        <div class="space-y-4 w-full">
          {% for artist in top_artists[:5] %}
            <div class="flex items-center space-x-4 {% if loop.index == 1 %}text-xl{% else %}text-base{% endif %} transform hover:scale-110 transition duration-300">
              <div class="bg-gradient-to-br from-indigo-400 to-pink-400 p-3 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A9 9 0 1112 21a9 9 0 01-6.879-3.196z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </div>
              <p class="font-bold text-indigo-700">#{{ loop.index }} {{ artist }}</p>
            </div>
          {% endfor %}
        </div>
      </div>    

    </div>

  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Total Minutes by Track (Bar Chart)
    const minutesByTrackCtx = document.getElementById('minutesByTrack').getContext('2d');
    new Chart(minutesByTrackCtx, {
        type: 'bar',
        data: {
            labels: {{ minutes_by_track.labels | tojson | safe }},
            datasets: [{
                label: 'Minutes Played',
                data: {{ minutes_by_track.data | tojson | safe }},
                backgroundColor: '#a5b4fc',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { text: 'Minutes', display: true }
                },
                x: {
                    title: { text: 'Track', display: true }
                }
            }
        }
    });

    // Danceability vs Energy (Bubble Chart)
    const danceabilityEnergyCtx = document.getElementById('danceabilityEnergy').getContext('2d');
    new Chart(danceabilityEnergyCtx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: 'Tracks',
                data: {{ danceability_energy.data | tojson | safe }},
                backgroundColor: '#a5b4fc',
                borderColor: '#6366F1'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'left', align: 'start' }
            },
            scales: {
                x: {
                    title: { text: 'Danceability', display: true }
                },
                y: {
                    title: { text: 'Energy', display: true }
                }
            }
        }
    });

    // Mood Profile (Radar Chart)
    const moodProfileCtx = document.getElementById('moodProfile').getContext('2d');
    new Chart(moodProfileCtx, {
        type: 'radar',
        data: {
            labels: ['Danceability', 'Energy', 'Valence', 'Acousticness', 'Liveness'],
            datasets: [{
                label: 'Your Mood Profile',
                data: {{ mood_profile.data | tojson | safe }},
                backgroundColor: 'rgba(169, 176, 207, 0.2)',
                borderColor: '#a5b4fc',
                pointBackgroundColor: '#6366F1'
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 1
                }
            }
        }
    });

    // Mode Analysis (Stacked Bar)
    const modeCtx = document.getElementById('modeChart').getContext('2d');
    new Chart(modeCtx, {
        type: 'bar',
        data: {
            labels: ['Major', 'Minor'],
            datasets: [{
                label: 'Minutes Played',
                data: {{ mode.data | tojson | safe }},
                backgroundColor: ['#a5b4fc', '#f472b6']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { text: 'Minutes', display: true }
                }
            }
        }
    });
</script>
{% endblock %}