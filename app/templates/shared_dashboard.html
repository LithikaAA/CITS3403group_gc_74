{% extends "base.html" %}
{% block title %}Friend Comparison Dashboard | VibeShare{% endblock %}

{% block head %}
<!-- Reference to external CSS file -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared-dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="w-full max-w-screen-2xl mx-auto px-4 py-10 pt-14">
  {% if not shared_playlists or shared_playlists|length == 0 %}
  <!-- No Friends Message -->
  <div class="dashboard-card no-friends-container">
    <svg class="no-friends-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
    </svg>
    <h2 class="no-friends-title">No Shared Playlists Yet</h2>
    <p class="no-friends-description">You don't have any shared playlists from friends yet. Go to the Friends tab to connect with friends and ask them to share their playlists with you.</p>
    <a href="{{ url_for('share.share') }}" class="friends-button">
      Go to Friends Tab
    </a>
  </div>
  {% else %}
  <div class="space-y-12">
    <!-- Playlist Selection Dropdowns -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
      <!-- Your Playlist Selector -->
      <div class="mb-6">
        <label for="yourPlaylistSelect" class="block text-lg font-semibold text-gray-700 mb-2">Select Your Playlist:</label>
        <div class="relative w-full">
          <select
            id="yourPlaylistSelect"
            name="your_playlist_id"
            class="block w-full appearance-none px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-700 focus:ring-2 focus:ring-indigo-300 focus:outline-none">
            <option value="" disabled selected hidden>Select Your Playlist</option>
            {% for playlist in playlists %}
            <option value="{{ playlist.id }}">{{ playlist.name }}</option>
            {% endfor %}
          </select>
          <!-- Custom dropdown arrow -->
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </div>
      </div>
      
      <!-- Friend's Playlist Selector -->
      <div class="mb-6">
        <label for="friendPlaylistSelect" class="block text-lg font-semibold text-gray-700 mb-2">Select Friend's Playlist:</label>
        <div class="relative w-full">
          <select
            id="friendPlaylistSelect"
            name="friend_playlist_id"
            class="block w-full appearance-none px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-700 focus:ring-2 focus:ring-indigo-300 focus:outline-none">
            <option value="" disabled selected hidden>Choose a Friend's Playlist</option>
            {% for share in shared_playlists %}
            <option value="{{ share.playlist.id }}">{{ share.owner.username }} - {{ share.playlist.name }}</option>
            {% endfor %}
          </select>
          <!-- Custom dropdown arrow -->
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Main Charts Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div class="bg-white rounded-2xl shadow-lg p-8 transition transform duration-300 hover:scale-105 hover:shadow-2xl chart-container">
        <h2 class="text-2xl font-bold text-grey-700 mb-2">Total Minutes Played by Track</h2>
        <p class="text-sm text-gray-500 mb-6">Top different songs between you and your friend.</p>
        <div class="w-full overflow-x-auto">
          <canvas id="minutesByTrack" class="w-full h-auto max-w-full"></canvas>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-8 transition transform duration-300 hover:scale-105 hover:shadow-2xl chart-container">
        <h2 class="text-2xl font-bold text-grey-700 mb-2">Danceability vs Energy</h2>
        <p class="text-sm text-gray-500 mb-6">You vs friend. Different colour dots show each of your tracks.</p>
        <div class="w-full overflow-x-auto">
          <canvas id="danceabilityEnergy" class="w-full h-auto max-w-full"></canvas>
        </div>
      </div>
    </div>

    <!-- Grid Section -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">

      <!-- Music Summary Card -->
      <div class="bg-white rounded-2xl shadow-lg p-6 dashboard-card">
        <h2 class="text-lg font-bold text-gray-800 mb-4">You & Friend Summary</h2>
        
        <div class="space-y-3">
          <div>
            <p class="text-sm font-medium text-gray-700">Top Common Track:</p>
            <p class="font-semibold text-indigo-600" data-summary="common-track">{{ shared_summary.common_track }}</p>
          </div>
          
          <div>
            <p class="text-sm font-medium text-gray-700">Your Avg Tempo:</p>
            <p class="font-semibold text-indigo-600" data-summary="your-avg-tempo">{{ shared_summary.your_avg_tempo }} BPM</p>
          </div>
          
          <div>
            <p class="text-sm font-medium text-gray-700">Friend's Avg Tempo:</p>
            <p class="font-semibold text-pink-600" data-summary="friend-avg-tempo">{{ shared_summary.friend_avg_tempo }} BPM</p>
          </div>
          
          <div>
            <p class="text-sm font-medium text-gray-700">Total Minutes (You):</p>
            <p class="font-semibold text-indigo-600" data-summary="your-total-minutes">{{ shared_summary.your_total_minutes }}</p>
          </div>
          
          <div>
            <p class="text-sm font-medium text-gray-700">Total Minutes (Friend):</p>
            <p class="font-semibold text-pink-600" data-summary="friend-total-minutes">{{ shared_summary.friend_total_minutes }}</p>
          </div>
          
          <div>
            <p class="text-sm font-medium text-gray-700">Your Mood:</p>
            <p class="font-semibold text-indigo-600" data-summary="your-mood">{{ shared_summary.your_mood }}</p>
          </div>
          
          <div>
            <p class="text-sm font-medium text-gray-700">Friend's Mood:</p>
            <p class="font-semibold text-pink-600" data-summary="friend-mood">{{ shared_summary.friend_mood }}</p>
          </div>
        </div>
      </div>

      <!-- Mood Profile Radar Chart -->
      <div class="bg-white rounded-2xl shadow-lg p-8 dashboard-card chart-container">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Mood Profile Comparison</h2>
        <p class="text-xs text-gray-400 mb-4">You vs friend, colour coded.</p>
        <canvas id="moodProfile" class="w-full h-auto max-w-full"></canvas>
      </div>

      <!-- Listening Time by Mode -->
      <div class="bg-white rounded-2xl shadow-lg p-8 dashboard-card chart-container">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Mode Comparison</h2>
        <p class="text-xs text-gray-400 mb-4">Major (Happy) vs Minor (Emotional) â€” stacked by user.</p>
        <canvas id="modeChart" class="w-full h-auto max-w-full"></canvas>
      </div>

      <!-- Top 5 Popular Songs -->
      <div class="bg-white rounded-2xl shadow-lg p-8 dashboard-card">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Top 5 Popular Songs</h2>
        <p class="text-xs text-gray-400 mb-4">Based on popularity score.</p>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <p class="font-semibold text-indigo-700">Your Top Songs</p>
            <ul class="text-sm text-gray-600 your-top-songs">
              {% for song in top_popular_songs.you %}
              <li class="flex items-center py-1">
                <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-800 flex items-center justify-center text-xs font-bold mr-2 flex-shrink-0">#{{ loop.index }}</span>
                <span class="truncate">{{ song.title }} - {{ song.artist }}</span>
              </li>
              {% endfor %}
            </ul>
          </div>
          <div class="mt-3">
            <p class="font-semibold text-pink-600">Friend's Top Songs</p>
            <ul class="text-sm text-gray-600 friend-top-songs">
              {% for song in top_popular_songs.friend %}
              <li class="flex items-center py-1">
                <span class="w-6 h-6 rounded-full bg-pink-100 text-pink-800 flex items-center justify-center text-xs font-bold mr-2 flex-shrink-0">#{{ loop.index }}</span>
                <span class="truncate">{{ song.title }} - {{ song.artist }}</span>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Pass data to JavaScript as globals -->
  <script>
    // Initial data for charts from the server
    window.initialMinutesData = {
      labels: {{ comparison_minutes.labels | tojson | safe }},
      yourData: {{ comparison_minutes.your_data | tojson | safe }},
      friendData: {{ comparison_minutes.friend_data | tojson | safe }}
    };
    
    window.initialBubbleData = {
      you: {{ comparison_bubble.you | tojson | safe }},
      friend: {{ comparison_bubble.friend | tojson | safe }}
    };
    
    window.initialMoodData = {
      you: {{ comparison_mood.you | tojson | safe }},
      friend: {{ comparison_mood.friend | tojson | safe }}
    };
    
    window.initialModeData = {
      you: {{ comparison_mode.you | tojson | safe }},
      friend: {{ comparison_mode.friend | tojson | safe }}
    };

    window.initialPopularSongsData = {
      you: {{ top_popular_songs.you | tojson | safe }},
      friend: {{ top_popular_songs.friend | tojson | safe }}
    };
  </script>
  
  <!-- Chart.js library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Reference to external JS files -->
  <script src="{{ url_for('static', filename='js/shared-dashboard-charts.js') }}"></script>
  <script src="{{ url_for('static', filename='js/shared-playlist-dropdown.js') }}"></script>
  {% endif %}
</div>
{% endblock %}