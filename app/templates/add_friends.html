{% extends "base.html" %}
{% block title %}Add a Friend | VibeShare{% endblock %}

{% block content %}
<!-- Flash Message Section -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="absolute top-4 right-4 space-y-2 z-50">
      {% for category, message in messages %}
        <div class="px-4 py-2 rounded-xl shadow-lg text-white {{ category == 'success' and 'bg-green-500' or 'bg-red-500' }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="flex h-screen w-full mx-auto relative overflow-x-hidden">
  
  <!-- Left Panel: Add Friend Form -->
  <div class="w-1/2 p-10 z-20 relative flex items-center justify-center">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-96">
      <h2 class="text-2xl font-bold mb-6">Add a Friend</h2>
      <form method="POST" action="{{ url_for('friends.add_friend') }}">
        {{ form.hidden_tag() }}
        <div class="space-y-4">
          {{ form.friend_username(class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-gray-50", placeholder="Enter their username") }}
          <!-- Purple gradient button that exactly matches the navbar -->
          {{ form.submit(class="w-full py-3 bg-gradient-to-r from-indigo-500 to-pink-500 text-white rounded-lg hover:shadow-md transition") }}
        </div>
      </form>
      <!-- view all friends -->
      <div class="mt-4 relative">
        <button
          id="view-all-friends-btn"
          class="w-full py-3 bg-gradient-to-r from-green-400 to-teal-500 text-white text-sm font-semibold rounded-xl shadow-md hover:shadow-lg hover:from-teal-500 hover:to-green-400 transition duration-300 ease-in-out relative"
        >
          View All Friends
          {% if incoming_requests|length > 0 %}
            <span class="absolute -top-1 -right-3 bg-red-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">
              {{ incoming_requests|length }}
            </span>
          {% endif %}
        </button>
      </div>
    </div>
  </div>

    <!-- Right Slide-in Overlay for All Friends -->
     <div class="w-1/2 relative flex items-center justify-center overflow-visible">
    <!-- SVG for connection lines -->
    <svg id="link-lines" class="absolute inset-0 w-full h-full z-0 pointer-events-none">
      <defs>
        {% for idx in range(top_friends|length) %}
        <linearGradient id="gradient-{{ idx }}" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#818cf8" />
          <stop offset="100%" stop-color="#ec4899" />
        </linearGradient>
        {% endfor %}
      </defs>
      {% for idx in range(top_friends[:20]|length) %}
      <line id="line-{{ idx }}" x1="0" y1="0" x2="0" y2="0" 
            stroke="url(#gradient-{{ idx }})" stroke-width="1" />
      {% endfor %}
    </svg>
    
    <!-- Friends Panel - Styled to match the screenshot -->
    <div id="friends-panel" class="fixed right-0 top-0 h-full w-80 bg-white shadow-xl transform translate-x-full transition-transform z-50">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold text-purple-600">Your Friends</h2>
          <button id="close-friends-panel" class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>

        <!-- Tab buttons - Styled to match the screenshot -->
        <div class="flex w-full bg-gray-100 rounded-lg mb-4 p-1">
          <button data-tab="all" class="tab-btn flex-1 py-2 text-center rounded-lg bg-white text-purple-600 font-medium shadow-sm">All</button>
          <button data-tab="incoming" class="tab-btn flex-1 py-2 text-center rounded-lg text-gray-500">Incoming</button>
          <button data-tab="outgoing" class="tab-btn flex-1 py-2 text-center rounded-lg text-gray-500">Outgoing</button>
        </div>

        <!-- Tab content -->
        <div id="tab-all" class="tab-content space-y-2">
          {% for f in current_user.all_friends %}
            <div class="flex items-center gap-4 bg-gray-50 rounded-xl p-3 shadow-sm hover:shadow-md transition">
              <img src="{{ url_for('static', filename='uploads/' ~ (f.profile_pic or 'default_profile.jpg')) }}"
                  alt="{{ f.username }}" class="w-10 h-10 rounded-full object-cover border">
              <span class="font-medium text-gray-800">{{ f.username }}</span>
            </div>
          {% else %}
            <p class="text-sm text-gray-400">No friends yet.</p>
          {% endfor %}
        </div>

        <div id="tab-incoming" class="tab-content hidden space-y-2">
          {% for req in incoming_requests %}
            <form method="POST" action="{{ url_for('friends.accept_friend', request_id=req.id) }}"
                  class="flex items-center justify-between bg-blue-50 rounded-xl p-3 shadow-sm hover:shadow-md transition">
              {{ accept_form.hidden_tag() }}
              <span class="font-medium text-blue-800">{{ req.user.username }}</span>
              {{ accept_form.submit(class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-600 transition") }}
            </form>
          {% else %}
            <p class="text-sm text-gray-400">No incoming friend requests.</p>
          {% endfor %}
        </div>

        <div id="tab-outgoing" class="tab-content hidden space-y-2">
          {% for req in sent_requests %}
            <div class="flex items-center gap-4 bg-pink-50 rounded-xl p-3 shadow-sm hover:shadow-md transition">
              <span class="font-medium text-pink-800">{{ req.friend.username }}</span>
            </div>
          {% else %}
            <p class="text-sm text-gray-400">No outgoing friend requests.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Central User Bubble with Username on hover - still clickable -->
    <div id="center-bubble" class="relative z-10 w-28 h-28 rounded-full overflow-hidden border-4 border-white shadow-lg transition-transform duration-300 hover:scale-110 cursor-pointer">
      <img src="{{ url_for('static', filename='uploads/' ~ (current_user.profile_pic if current_user.profile_pic else 'default_profile.jpg')) }}" alt="You" class="w-full h-full object-cover">
    </div>

    <!-- Orbiting friend bubbles (limit top 20) - with remove feature but no click event -->
    {% for friend in top_friends[:20] %}
      {% set idx = loop.index0 %}
      <div
        id="bubble-{{ idx }}"
        class="friend-bubble absolute rounded-full overflow-hidden border-4 border-white shadow-md cursor-pointer {% if friend.username in new_friend_usernames %}glow{% endif %}"
        data-idx="{{ idx }}"
        data-username="{{ friend.username }}"
        data-bpm="{{ friend.average_bpm }}"
        style="top:50%; left:50%;"
        title="{{ friend.username }}"
      >
        <img
          src="{{ url_for('static', filename='uploads/' ~ (friend.profile_pic or 'default_profile.jpg')) }}"
          alt="{{ friend.username }}"
          class="w-full h-full object-cover rounded-full"
        />
        <span class="friend-name absolute text-xs font-medium text-gray-700 whitespace-nowrap" 
              style="top:50%; left:50%;">
            {{ friend.username }}
        </span>
      </div>
    {% endfor %}

    <!-- Footer text - more aesthetic styling -->
    <div class="absolute bottom-8 w-full text-center">
      <div class="inline-block px-5 py-2 bg-white/90 backdrop-blur-sm rounded-full shadow-md">
        <span class="text-purple-600 font-semibold tracking-wide">
          Your Top 20 BPM Matches
        </span>
      </div>
    </div>
  </div>
</div>

<!-- Add hidden input with user BPM for JavaScript -->
<input type="hidden" id="user-bpm-data" value="{{ current_user.average_bpm or 0 }}">

{% block scripts %}
<script src="{{ url_for('static', filename='js/friends.js') }}"></script>
{% endblock %}
{% endblock %}