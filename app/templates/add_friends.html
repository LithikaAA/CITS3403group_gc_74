{% extends "base.html" %}
{% block title %}Add a Friend | VibeShare{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/friends.css') }}">
{% endblock %}

{% block content %}
<!-- Flash Message Section -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="absolute top-4 right-4 space-y-2 z-50">
      {% for category, message in messages %}
        <div class="px-4 py-2 rounded-xl shadow-lg text-white {{ category == 'success' and 'bg-green-500' or 'bg-red-500' }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="flex h-screen w-full mx-auto relative overflow-x-hidden">
  
  <!-- Left Panel: Add Friend Form -->
  <div class="w-1/2 p-10 z-20 relative flex items-center justify-center">
    <div class="bg-white p-8 rounded-xl shadow-xl w-96">
      <h2 class="text-2xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-pink-500">Add a Friend</h2>
      <form method="POST" action="{{ url_for('friends.add_friend') }}">
        {{ form.hidden_tag() }}
        <div class="space-y-4">
          {{ form.friend_username(class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-gray-50", placeholder="Enter their username") }}
          {{ form.submit(class="w-full py-3 bg-gradient-to-r from-indigo-500 to-pink-500 text-white rounded-lg hover:shadow-md transition") }}
        </div>
      </form>
      <div class="mt-4">
        <button
          id="view-all-friends-btn"
          class="w-full py-3 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition"
        >
          View All Friends
          {% if incoming_requests|length > 0 %}
            <span class="absolute -top-1 -right-3 bg-red-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">
              {{ incoming_requests|length }}
            </span>
          {% endif %}
        </button>
      </div>
    </div>
  </div>

  <!-- Right Visualization Area -->
  <div class="w-1/2 relative flex items-center justify-center overflow-visible">
    <!-- SVG for connection lines -->
    <svg id="link-lines" class="absolute inset-0 w-full h-full z-0 pointer-events-none">
      <defs>
        {% for idx in range(top_friends|length) %}
        <linearGradient id="gradient-{{ idx }}" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#9333ea" />
          <stop offset="100%" stop-color="#3b82f6" />
        </linearGradient>
        {% endfor %}
      </defs>
      {% for idx in range(top_friends[:20]|length) %}
      <line id="line-{{ idx }}" x1="0" y1="0" x2="0" y2="0" 
            stroke="url(#gradient-{{ idx }})" stroke-width="1" />
      {% endfor %}
    </svg>
    
    <!-- Friends Panel -->
    <div id="friends-panel" class="fixed right-0 top-0 h-full w-80 bg-white shadow-xl transform translate-x-full transition-transform z-50">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold text-purple-600">Your Friends</h2>
          <button id="close-friends-panel" class="text-gray-400 hover:text-gray-600">✕</button>
        </div>

        <!-- Tab buttons -->
        <div class="flex w-full bg-gray-100 rounded-lg mb-4 p-1">
          <button data-tab="all" class="tab-btn flex-1 py-2 text-center rounded-lg bg-white text-purple-600 font-medium shadow-sm">All</button>
          <button data-tab="incoming" class="tab-btn flex-1 py-2 text-center rounded-lg text-gray-500">Incoming</button>
          <button data-tab="outgoing" class="tab-btn flex-1 py-2 text-center rounded-lg text-gray-500">Outgoing</button>
        </div>

        <!-- All Friends -->
        <div id="tab-all" class="tab-content space-y-2">
          {% for f in current_user.all_friends %}
            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
              <div class="w-9 h-9 rounded-full overflow-hidden mr-3">
                <img src="{{ url_for('static', filename='uploads/' ~ (f.profile_pic or 'default_profile.jpg')) }}" 
                     class="w-full h-full object-cover">
              </div>
              <span class="font-medium">{{ f.username }}</span>
            </div>
          {% else %}
            <p class="text-sm text-gray-400 p-3 bg-gray-50 rounded-lg">No friends</p>
          {% endfor %}
        </div>

        <!-- Incoming Requests -->
        <div id="tab-incoming" class="tab-content hidden space-y-2">
          {% for req in incoming_requests %}
            <form method="POST" action="{{ url_for('friends.accept_friend', request_id=req.id) }}">
              {{ accept_form.hidden_tag() }}
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                  <div class="w-9 h-9 rounded-full overflow-hidden mr-3">
                    <img src="{{ url_for('static', filename='uploads/' ~ (req.user.profile_pic or 'default_profile.jpg')) }}" 
                         class="w-full h-full object-cover">
                  </div>
                  <span class="font-medium">{{ req.user.username }}</span>
                </div>
                {{ accept_form.submit(class="bg-green-500 text-white px-3 py-1 rounded-md text-sm") }}
              </div>
            </form>
          {% else %}
            <p class="text-sm text-gray-400 p-3 bg-gray-50 rounded-lg">No incoming requests</p>
          {% endfor %}
        </div>

        <!-- Outgoing Requests -->
        <div id="tab-outgoing" class="tab-content hidden space-y-2">
          {% for req in sent_requests %}
            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
              <div class="w-9 h-9 rounded-full overflow-hidden mr-3">
                <img src="{{ url_for('static', filename='uploads/' ~ (req.friend.profile_pic or 'default_profile.jpg')) }}" 
                     class="w-full h-full object-cover">
              </div>
              <span class="font-medium">{{ req.friend.username }}</span>
              <span class="ml-auto text-xs text-gray-400">Pending</span>
            </div>
          {% else %}
            <p class="text-sm text-gray-400 p-3 bg-gray-50 rounded-lg">No outgoing requests</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Central User Bubble -->
    <div id="center-bubble" class="relative z-10 w-28 h-28 rounded-full overflow-hidden border-4 border-white shadow-lg transition-transform duration-300 hover:scale-110 cursor-pointer">
      <img src="{{ url_for('static', filename='uploads/' ~ (current_user.profile_pic if current_user.profile_pic else 'default_profile.jpg')) }}" alt="You" class="w-full h-full object-cover">
      <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 hover:opacity-100 transition-opacity">
        <span class="text-white font-medium text-sm truncate px-2 text-center">
          {{ current_user.username }}
        </span>
      </div>
    </div>

    <!-- Orbiting friend bubbles (limit top 20) -->
    {% for friend in top_friends[:20] %}
      {% set idx = loop.index0 %}
      <div
        id="bubble-{{ idx }}"
        class="friend-bubble absolute rounded-full overflow-hidden border-4 border-white shadow-md {% if friend.username in new_friend_usernames %}glow{% endif %}"
        data-idx="{{ idx }}"
        data-username="{{ friend.username }}"
        data-bpm="{{ friend.average_bpm }}"
        style="top:50%; left:50%;"
      >
        <img
          src="{{ url_for('static', filename='uploads/' ~ (friend.profile_pic or 'default_profile.jpg')) }}"
          alt="{{ friend.username }}"
          class="w-full h-full object-cover rounded-full"
        />
        <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 hover:opacity-100 transition-opacity">
          <span class="text-white font-medium text-xs truncate px-2 text-center">
            {{ friend.username }}
          </span>
        </div>
        <button 
          class="remove-friend-btn absolute bottom-1 right-1 w-6 h-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-full flex items-center justify-center opacity-0 transition-opacity z-20"
          data-username="{{ friend.username }}"
          title="Remove {{ friend.username }}"
        >
          ✕
        </button>
      </div>
    {% endfor %}

    <!-- Footer text -->
    <div class="absolute bottom-8 w-full text-center">
      <div class="inline-block px-5 py-2 bg-white/90 backdrop-blur-sm rounded-full shadow-md">
        <span class="text-purple-600 font-semibold tracking-wide">
          Your Top 20 BPM Matches
        </span>
      </div>
    </div>
  </div>
</div>

<!-- Hidden input for user BPM -->
<input type="hidden" id="user-bpm-data" value="{{ current_user.average_bpm or 0 }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/friends.js') }}"></script>
{% endblock %}